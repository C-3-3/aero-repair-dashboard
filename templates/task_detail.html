{% extends "base.html" %}
{% block title %}Task Details{% endblock %}

{% block content %}
<h2>üîç Task Details</h2>

<p><strong>Work Order:</strong> {{ work_order.work_order_id }}</p>
<p><strong>Aircraft:</strong> {{ work_order.aircraft }}</p>
<p><strong>Location:</strong> {{ work_order.location }}</p>

<form method="POST">
  <label>Status:
    <select name="status">
      <option value="Open" {% if task.status == "Open" %}selected{% endif %}>Open</option>
      <option value="In Progress" {% if task.status == "In Progress" %}selected{% endif %}>In Progress</option>
      <option value="Done" {% if task.status == "Done" %}selected{% endif %}>Done</option>
    </select>
  </label>

  <br><br>

  <label>Comment:<br>
    <textarea name="comment" rows="4" cols="50" placeholder="Add any notes..."></textarea>
  </label>

  <br><br>

  <button type="submit">‚úÖ Submit Update</button>
    <hr>
<h3>üïí Recent Updates</h3>

{% if recent_updates %}
  <ul>
    {% for update in recent_updates %}
    <li>
      <strong>Status:</strong> {{ update[0] }}<br>
      <strong>Comment:</strong> {{ update[1] or "‚Äî" }}<br>
      <em>{{ update[2] }}</em>
    </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No updates yet.</p>
{% endif %}


</form>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul style="margin-top: 1rem;">
      {% for category, message in messages %}
        <li><strong>{{ category.title() }}:</strong> {{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<hr>
<h3>Recent Updates</h3>
<ul>
  {% with conn = sqlite3.connect('task_updates.db') %}
  {% set c = conn.cursor() %}
  {% set rows = c.execute("SELECT status, comment, timestamp FROM task_updates WHERE work_order_id = ? AND task_id = ? ORDER BY timestamp DESC LIMIT 5", [work_order.work_order_id, task.task_id]).fetchall() %}
  {% do conn.close() %}
    {% for row in rows %}
    <li>
      <strong>Status:</strong> {{ row[0] }} <br>
      <strong>Comment:</strong> {{ row[1] or "‚Äî" }} <br>
      <em>{{ row[2] }}</em>
    </li>
    {% endfor %}
  {% endwith %}
</ul>


<p><strong>Next steps:</strong></p>
<ul>
  <li>Status dropdown (coming soon)</li>
  <li>Comment box for notes</li>
  <li>Save / Mark complete</li>
</ul>

<a href="{{ url_for('workorders') }}">‚Üê Back to Work Orders</a>
{% endblock %}